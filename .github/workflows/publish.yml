name: Bump and Publish

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: oven-sh/setup-bun@v2

      - uses: actions/setup-node@v4
        with:
          node-version: '24.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: bun install

      - name: Build package
        run: bun run build

      - name: Publish to JSR
        run: bunx jsr publish

      - name: Publish to NPM
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Notify Webhook
        if: success()
        run: |
          VERSION=$(node -p "require('./package.json').version")
          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)
          REPO_URL="https://github.com/${{ github.repository }}"
          JSR_URL="https://jsr.io/@cludz/sdk@$VERSION"
          NPM_URL="https://www.npmjs.com/package/@cludz/sdk/v/$VERSION"
          RUN_ID="${{ github.run_id }}"
          
          curl -X POST "${{ secrets.WEBHOOK_URL }}" \
            -H "X-Webhook-Key: ${{ secrets.WEBHOOK_SECRET }}" \
            -H "Content-Type: application/json" \
            -d "{\"message\": \"[New Version] @cludz/sdk v$VERSION\n\nCommit: $COMMIT_MSG\nJSR: $JSR_URL\nNPM: $NPM_URL\nRun ID: $RUN_ID\nRepo: $REPO_URL\"}"
